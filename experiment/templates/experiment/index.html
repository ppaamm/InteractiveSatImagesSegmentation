{% extends 'base.html' %}

{%  load static %}

{% block extra_css %}
      <link rel= "stylesheet" href="{% static 'experiment/style.css'%}">
{% endblock %}


{% block content %}

<div class="box">
    <div class="title-container">
        <div class = "title">Display a plot</div>
    </div>
    
    
    
    <div class="main-text">
    <!--
        {% if image_url %}
            <img src="{{ image_url }}" alt="Original image" id="image-display">
        {% else %}
            <p>No image to show.</p>
        {% endif %} -->
        
        <div class="image-overlay-container">
            <img src="{{ background_image_url }}" alt="Background" class="background-image">
            <img src="{{ overlay_image_url }}" alt="Overlay" id="overlay-image" style="opacity: {{ overlay_opacity }};">
        </div>
        
        <div style="margin-top: 15px;">
            <label>
                <input type="checkbox" id="toggle-segmentation" checked>
                Display segmentation
            </label>
        </div>
        
        <div id="segmentation-status" style="margin-top: 10px;">Segmentation loading in progress...</div>
        <div style="margin-top: 20px;">
            <button id="next-step-btn">Next AI step</button>
        </div>
    </div>
    
</div>

{% endblock %}

{% block script %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const checkbox = document.getElementById("toggle-segmentation");
    const overlay = document.getElementById("overlay-image");
    
    if (checkbox && overlay) {
        checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
                overlay.style.opacity = "{{ overlay_opacity }}";
            } else {
                overlay.style.opacity = "0";
            }
        });
    }
});


document.addEventListener("DOMContentLoaded", function () {
    const overlay = document.getElementById("overlay-image");
    const checkbox = document.getElementById("toggle-segmentation");
    const status = document.getElementById("segmentation-status");
    const imageParam = new URLSearchParams(window.location.search).get('image') || 'source-image';

    if (checkbox && overlay) {
        checkbox.addEventListener("change", () => {
            if (checkbox.checked) {
                overlay.style.opacity = "{{ overlay_opacity }}";
            } else {
                overlay.style.opacity = "0";
            }
        });
    };

    fetch(`/experiment/load_segmentation/?image=${imageParam}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                /*
                overlay.src = data.url;
                overlay.style.opacity = checkbox && checkbox.checked ? "1" : "0";
                */
                status.textContent = "Segmentation loaded.";
            } else {
                status.textContent = "Failed to load segmentation.";
                console.error(data.message);
            }
        })
        .catch(err => {
            status.textContent = "Failed to load segmentation.";
            console.error(err);
        });
});


document.getElementById("next-step-btn").addEventListener("click", function () {
    const imageParam = new URLSearchParams(window.location.search).get('image') || 'source-image';

    fetch(`/experiment/next_step/?image=${imageParam}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                console.log("K Means worked")
            } else {
                console.error(data.message);
            }
        })
        .catch(err => {
            console.error("Error:", err);
        });
});
</script>
{% endblock script %}
